<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>أبشر — بصمة سلوكية (محاكاة React)</title>
  <!-- React & Babel (for quick demo) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --teal:#00a98f; --deep:#006a5c; --bg:#7de2c5; }
    body{font-family:Inter, system-ui, sans-serif; margin:0; background:var(--bg); padding:24px; direction:rtl;}
    .app{max-width:1100px;margin:0 auto;background:#fff;border-radius:18px;padding:22px;box-shadow:0 10px 40px rgba(0,0,0,.12);}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:56px;height:56px}
    h1{margin:0;color:var(--deep);font-size:20px}
    .row{display:flex;gap:18px;align-items:flex-start}
    .col{flex:1}
    .card{background:#fbfffe;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .btn{background:var(--teal);color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;display:inline-block;border:none;cursor:pointer}
    .muted{color:#586e63;font-size:14px}
    .stats{display:flex;gap:12px;margin-top:10px}
    .stat{background:#fff;border-radius:10px;padding:10px;flex:1;text-align:center}
    canvas{max-width:100%;height:260px}
    pre{background:#eefaf6;padding:12px;border-radius:8px;overflow:auto}
    footer{margin-top:18px;color:#2e524a;font-size:13px}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Logo asset -->
  <script type="text/plain" id="logo-svg">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">
    <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#00d3b0"/><stop offset="1" stop-color="#008f75"/></linearGradient></defs>
    <rect width="120" height="120" rx="20" fill="url(#g)"/>
    <g transform="translate(14 14)" fill="#fff">
      <path d="M38 8c-9 0-18 8-18 17v22h8V25c0-6 5-11 10-11 6 0 10 5 10 11v34h8V25c0-9-9-17-18-17z"/>
      <circle cx="86" cy="86" r="14" fill="#fff" opacity="0.12"/>
    </g>
  </svg>
  </script>

  <!-- Application code (React via Babel for quick demo) -->
  <script type="text/babel">
  const {useState, useEffect, useRef} = React;

  // --- Mock API (simulated) ---
  const MockAPI = {
    users: [{id:1, name:'محمد', fingerprint:null}],
    createFingerprint(userId, fingerprint){
      return new Promise(res => {
        setTimeout(()=>{
          const user = this.users.find(u=>u.id===userId);
          if(user){ user.fingerprint = fingerprint; res({ok:true, fingerprint}); }
          else res({ok:false});
        }, 800);
      });
    },
    verifyFingerprint(userId, sample){
      return new Promise(res => {
        setTimeout(()=>{
          const user = this.users.find(u=>u.id===userId);
          if(!user || !user.fingerprint) return res({ok:false, reason:'no_fingerprint'});
          // simple similarity: cosine-like between two vectors
          const a = user.fingerprint.vector, b = sample.vector;
          const dot = a.reduce((s,x,i)=>s + x*b[i], 0);
          const magA = Math.sqrt(a.reduce((s,x)=>s+x*x,0));
          const magB = Math.sqrt(b.reduce((s,x)=>s+x*x,0));
          const sim = magA && magB ? dot/(magA*magB) : 0;
          res({ok:true, similarity:sim});
        }, 500);
      });
    }
  };

  // --- Utility to compute simple fingerprint from events ---
  function computeFingerprintFromEvents(events){
    // events: {mouseDeltas:[], keyIntervals:[], pressureSamples:[]}
    const avg = arr => arr.length? arr.reduce((a,b)=>a+b,0)/arr.length:0;
    const std = arr => {
      if(!arr.length) return 0;
      const m = avg(arr);
      return Math.sqrt(arr.reduce((s,x)=>s+(x-m)*(x-m),0)/arr.length);
    };
    const features = [
      avg(events.mouseDeltas||[]),
      std(events.mouseDeltas||[]),
      avg(events.keyIntervals||[]),
      std(events.keyIntervals||[]),
      avg(events.pressureSamples||[]),
      std(events.pressureSamples||[])
    ];
    // normalize vector length to 6
    return { vector: features.map(x=>Number.isFinite(x)?x:0) };
  }

  function useBehaviorCapture(enabled){
    const eventsRef = useRef({mouseDeltas:[], keyIntervals:[], pressureSamples:[], lastMouse:[null,null], lastKeyTime:null});
    useEffect(()=>{
      if(!enabled) return;
      const onMouseMove = e=>{
        const r = eventsRef.current;
        if(r.lastMouse[0]===null){ r.lastMouse = [e.clientX, e.clientY]; return; }
        const dx = Math.hypot(e.clientX - r.lastMouse[0], e.clientY - r.lastMouse[1]);
        r.mouseDeltas.push(dx);
        r.lastMouse = [e.clientX, e.clientY];
        if(r.mouseDeltas.length>200) r.mouseDeltas.shift();
      };
      const onKey = e=>{
        const r = eventsRef.current;
        const now = performance.now();
        if(r.lastKeyTime) r.keyIntervals.push(now - r.lastKeyTime);
        r.lastKeyTime = now;
        if(r.keyIntervals.length>200) r.keyIntervals.shift();
      };
      const onPointer = e=>{
        const r = eventsRef.current;
        if(e.pressure !== undefined) r.pressureSamples.push(e.pressure);
        if(r.pressureSamples.length>200) r.pressureSamples.shift();
      };
      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('keydown', onKey);
      window.addEventListener('pointermove', onPointer);
      return ()=>{
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('keydown', onKey);
        window.removeEventListener('pointermove', onPointer);
      };
    }, [enabled]);
    const snapshot = ()=> computeFingerprintFromEvents(eventsRef.current);
    return {snapshot, eventsRef};
  }

  function Logo({size=56}){
    const svg = document.getElementById('logo-svg').textContent;
    return <div className="logo" dangerouslySetInnerHTML={{__html:svg}} style={{width:size}} />;
  }

  function ChartCard({id, data, labels, title}){
    const ref = useRef(null);
    useEffect(()=>{
      if(!ref.current) return;
      const ctx = ref.current.getContext('2d');
      const chart = new Chart(ctx, {
        type:'line',
        data:{labels, datasets:[{label:title, data}]},
        options:{responsive:true, maintainAspectRatio:false, scales:{x:{display:false}}}
      });
      return ()=> chart.destroy();
    }, [data.join(','), labels.join(',')]);
    return <div className="card" style={{height:260}}><canvas ref={ref} /></div>;
  }

  function App(){
    const [user] = useState(MockAPI.users[0]);
    const [capturing, setCapturing] = useState(true);
    const [fingerprint, setFingerprint] = useState(user.fingerprint);
    const [lastSample, setLastSample] = useState(null);
    const [verifyRes, setVerifyRes] = useState(null);
    const [history, setHistory] = useState([]);

    const {snapshot, eventsRef} = useBehaviorCapture(capturing);

    const create = async ()=>{
      const sample = snapshot();
      const res = await MockAPI.createFingerprint(user.id, sample);
      if(res.ok){ setFingerprint(res.fingerprint); setHistory(h=>[{t:Date.now(), type:'create'}...h]); alert('تم إنشاء البصمة السلوكية للمستخدم'); }
    };

    const captureSample = ()=>{
      const s = snapshot();
      setLastSample(s);
      setHistory(h=>[{t:Date.now(), type:'sample'}...h]);
      return s;
    };

    const verify = async ()=>{
      const sample = captureSample();
      const res = await MockAPI.verifyFingerprint(user.id, sample);
      setVerifyRes(res);
      setHistory(h=>[{t:Date.now(), type:'verify', res}...h]);
    };

    // Chart data from eventsRef
    const mouseSeries = eventsRef.current.mouseDeltas.slice(-40);
    const keySeries = eventsRef.current.keyIntervals.slice(-40).map(x=>x||0);
    const pressureSeries = eventsRef.current.pressureSamples.slice(-40).map(x=>x||0);

    return (
      <div className="app">
        <header>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <Logo />
            <div>
              <h1>محاكاة نظام أبشر — بصمة سلوكية</h1>
              <div className="muted">نظام تجربة متكامل: إنشاء، تحقق، ورسوم بيانية لعرض السلوك</div>
            </div>
          </div>
        </header>

        <div className="row" style={{marginBottom:14}}>
          <div className="col card">
            <h3>التقاط سلوك المستخدم (مباشر)</h3>
            <p className="muted">حرّك الماوس، اكتب على لوحة المفاتيح أو استخدم اللمس لملء بيانات السلوك.</p>
            <div style={{marginTop:10}}>
              <button className="btn" onClick={()=>setCapturing(c=>!c)}>{capturing? 'إيقاف الالتقاط' : 'تشغيل الالتقاط'}</button>
              <button className="btn" style={{marginLeft:8}} onClick={captureSample}>التقاط عيّنة الآن</button>
              <button className="btn" style={{marginLeft:8}} onClick={create}>إنشاء بصمة للمستخدم</button>
              <button className="btn" style={{marginLeft:8}} onClick={verify}>تحقق الآن</button>
            </div>

            <div className="stats">
              <div className="stat"><strong>{mouseSeries.length}</strong><div className="muted">نقاط ماوس</div></div>
              <div className="stat"><strong>{keySeries.length}</strong><div className="muted">ضغطات</div></div>
              <div className="stat"><strong>{pressureSeries.length}</strong><div className="muted">عينات ضغط</div></div>
            </div>

            <div style={{marginTop:12}}>
              <div className="muted">البصمة الحالية (متجه سمات):</div>
              <pre>{fingerprint? JSON.stringify(fingerprint.vector.map(v=>+v.toFixed(3)), null, 2) : 'لا توجد بصمة'}</pre>
            </div>
          </div>

          <div className="col card">
            <h3>لوحة تحكم متقدمة</h3>
            <p className="muted">عرض حالة المستخدم ونتائج التحقق الأخيرة.</p>
            <div style={{marginTop:10}}>
              <div><strong>المستخدم:</strong> {user.name}</div>
              <div><strong>حالة البصمة:</strong> {fingerprint? 'مخزنة' : 'غير موجودة'}</div>
              <div style={{marginTop:8}}>
                <strong>آخر نتيجة تحقق:</strong>
                <div>{verifyRes ? (verifyRes.ok ? `تشابه: ${verifyRes.similarity.toFixed(3)}` : verifyRes.reason) : 'لا توجد'}</div>
              </div>
            </div>

            <div style={{marginTop:12}}>
              <strong>سجل الأحداث (أحدث 8)</strong>
              <div style={{marginTop:8}}>
                <ul>
                  {history.slice(0,8).map((h,i)=>(
                    <li key={i}>
                      {new Date(h.t).toLocaleTimeString()} — {h.type} {h.res ? JSON.stringify(h.res) : ''}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div className="row" style={{marginTop:18}}>
          <div className="col card">
            <h3>رسوم بيانية لعرض السلوك</h3>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12, marginTop:8}}>
              <ChartCard id="m" data={mouseSeries} labels={mouseSeries.map((_,i)=>i)} title="حركة الماوس (دلتا)"/>
              <ChartCard id="k" data={keySeries} labels={keySeries.map((_,i)=>i)} title="فواصل الضغطة (ms)"/>
            </div>
          </div>

          <div className="col card">
            <h3>تفاصيل العيّنة الأخيرة</h3>
            <div style={{marginTop:8}}>
              <div className="muted">العينة الحالية (المتجه):</div>
              <pre>{lastSample? JSON.stringify(lastSample.vector.map(v=>+v.toFixed(3)), null, 2) : 'لم يتم التقاط عينة'}</pre>
              <div style={{marginTop:8}} className="muted">معلومات تقنية: المتجه مكوّن من متوسط/تباين الماوس، متوسط/تباين الضغوط، متوسط/تباين الضغط.</div>
            </div>
          </div>
        </div>

        <footer>
          <div>محاكاة متكاملة — يمكن رفع هذا المشروع إلى GitHub كما هو (static HTML + React CDN).</div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
